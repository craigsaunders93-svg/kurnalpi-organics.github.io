<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout - Kurnalpi Organics</title>
<link rel="stylesheet" href="style.css">

<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background-image: url('background.jpg');
    background-size: cover;
    background-attachment: fixed;
    color: white;
}
main {
    padding: 40px;
    position: relative;
}
main::before {
    content: "";
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: -1;
}
.container {
    max-width: 900px;
    margin: auto;
    background: rgba(47, 93, 58, 0.9);
    padding: 30px;
    border-radius: 10px;
}
h1, h2 { text-align: center; }
.grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
@media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
label { display: block; margin-top: 10px; }
input, textarea { width: 100%; padding: 8px; margin-top: 5px; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.2); }
.summary p { display: flex; justify-content: space-between; }
.total { font-size: 20px; font-weight: bold; }
button { width: 100%; margin-top: 10px; padding: 12px; font-size: 16px; border: none; border-radius: 6px; cursor: pointer; }
.whatsapp { background: #25d366; color: white; }
.email { background: #ffd700; color: black; }
.eft-box { display: none; background: #fff; color: #000; padding: 20px; border-radius: 8px; margin-top: 15px; }
.thank-you { display: none; text-align: center; }
</style>
</head>

<body>
<header class="site-header">
    <div class="header-inner">
        <a href="index.html"><img src="logo.png" class="logo"></a>
        <nav class="nav">
            <a href="index.html">Home</a>
            <a href="products.html">Products</a>
            <a href="cart.html">Cart</a>
        </nav>
    </div>
</header>

<main>
<div class="container">

<!-- CHECKOUT -->
<div id="checkout-section">
<h1>Checkout</h1>

<div class="grid">
<div>
    <h2>Your Details</h2>
    <label>Name</label>
    <input id="name" required>
    <label>Phone</label>
    <input id="phone" required>
    <label>Email</label>
    <input id="email">
    <label>Delivery Address</label>
    <textarea id="address" required></textarea>
    <label>Notes</label>
    <textarea id="notes"></textarea>
</div>

<div>
    <h2>Order Summary</h2>
    <table>
        <thead>
            <tr><th>Item</th><th>Qty</th><th>Price</th></tr>
        </thead>
        <tbody id="order-items"></tbody>
    </table>

    <div class="summary">
        <p><span>Subtotal</span><span id="subtotal">R0</span></p>
        <p><span>Shipping</span><span>R150</span></p>
        <p class="total"><span>Total</span><span id="total">R0</span></p>
    </div>

    <button class="whatsapp" onclick="checkoutWhatsApp()">Checkout via WhatsApp</button>
    <button class="email" onclick="checkoutEmail()">Checkout via Email</button>
    <button class="email" onclick="showEFT()">Pay via EFT</button>

    <!-- EFT BOX -->
    <div id="eft-box" class="eft-box">
        <h3>Bank Transfer (EFT)</h3>
        <p><strong>Bank:</strong> FNB</p>
        <p><strong>Account Name:</strong> Kurnalpi Organics</p>
        <p><strong>Account Number:</strong> 6313 4931 898</p>
        <p><strong>Branch Code:</strong> 250655</p>
        <p>
            <strong>Reference:</strong>
            <input type="text" id="eft-ref" readonly style="width: 150px; font-weight: bold; text-align: center;">
            <button onclick="copyEFTRef()" style="padding: 5px 10px; margin-left: 5px; cursor: pointer;">Copy</button>
        </p>
        <button class="whatsapp" onclick="eftConfirm()">I Have Paid ‚Äì Send Order</button>
    </div>
</div>
</div>
</div>

<!-- THANK YOU -->
<div id="thank-you" class="thank-you">
    <h1>Thank You!</h1>
    <p>Your order has been placed successfully.</p>
    <p>We will contact you shortly.</p>
    <button onclick="window.location.href='index.html'">Back to Home</button>
</div>

</div>
</main>

<footer>
&copy; 2026 Kurnalpi Organics
</footer>

<script>
const SHIPPING = 150;
let ORDER_REF = null;

// Input elements
let inputName, inputPhone, inputEmail, inputAddress, inputNotes;
function initInputs() {
    inputName = document.getElementById("name");
    inputPhone = document.getElementById("phone");
    inputEmail = document.getElementById("email");
    inputAddress = document.getElementById("address");
    inputNotes = document.getElementById("notes");
}

// Generate unique order reference
function generateOrderReference() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    const rand = Math.floor(1000 + Math.random()*9000);
    return `KPO-${y}${m}${day}-${rand}`;
}

// Cart helpers
function getCart() { return JSON.parse(localStorage.getItem("cart")) || []; }
function clearCart() { localStorage.removeItem("cart"); }

// Load checkout page
function loadCheckout() {
    initInputs();
    const cart = getCart();
    if (cart.length === 0) {
        alert("Your cart is empty.");
        window.location.href = "cart.html";
        return;
    }

    ORDER_REF = generateOrderReference();
    const eftRefInput = document.getElementById("eft-ref");
    if (eftRefInput) eftRefInput.value = ORDER_REF;

    let subtotal = 0;
    const tbody = document.getElementById("order-items");
    tbody.innerHTML = "";
    cart.forEach(item => {
        subtotal += item.price * item.quantity;
        tbody.innerHTML += `
            <tr>
                <td>${item.name}</td>
                <td>${item.quantity}</td>
                <td>R${(item.price * item.quantity).toFixed(2)}</td>
            </tr>`;
    });

    document.getElementById("subtotal").textContent = "R" + subtotal.toFixed(2);
    document.getElementById("total").textContent = "R" + (subtotal + SHIPPING).toFixed(2);
}

// Build order message
function buildMessage(paymentMethod="Online") {
    const cart = getCart();
    let msg = `üßæ NEW ORDER\nReference: ${ORDER_REF}\nPayment Method: ${paymentMethod}\n\n`;
    cart.forEach(item => {
        msg += `${item.name} x ${item.quantity} - R${(item.price * item.quantity).toFixed(2)}\n`;
    });
    msg += `\nTotal (incl shipping): ${document.getElementById("total").textContent}\n\n`;
    msg += `Name: ${inputName.value}\nPhone: ${inputPhone.value}\nEmail: ${inputEmail.value}\nAddress: ${inputAddress.value}\n`;
    if(inputNotes.value) msg += `Notes: ${inputNotes.value}\n`;
    return msg;
}

// Complete order
function completeOrder() {
    clearCart();
    document.getElementById("checkout-section").style.display = "none";
    document.getElementById("thank-you").style.display = "block";
}

// Send email
function sendEmailNotification(message) {
    return fetch("http://localhost:5000/send-email", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message, orderRef: ORDER_REF, toEmail: "kurnalpiorganics@gmail.com" })
    })
    .then(res=>res.json())
    .then(()=> { console.log("üìß Email sent:", ORDER_REF); return true; })
    .catch(err=> { console.error("‚ùå Email error:", err.message); return false; });
}

// WhatsApp checkout
async function checkoutWhatsApp() {
    const message = buildMessage();
    window.open(`https://wa.me/27615136124?text=${encodeURIComponent(message)}`, "_blank");
    const emailSent = await sendEmailNotification(message);
    if(emailSent) completeOrder();
    else alert("Email could not be sent. Order still recorded in WhatsApp.");
}

// Email checkout
async function checkoutEmail() {
    const message = buildMessage();
    const emailSent = await sendEmailNotification(message);
    if(emailSent) completeOrder();
    else alert("Email could not be sent. Please try again.");
}

// EFT checkout
function showEFT() {
    const eftBox = document.getElementById("eft-box");
    const eftRefInput = document.getElementById("eft-ref");
    if(!ORDER_REF) ORDER_REF = generateOrderReference();
    if(eftRefInput) eftRefInput.value = ORDER_REF;
    eftBox.style.display = "block";
}

function copyEFTRef() {
    const eftRefInput = document.getElementById("eft-ref");
    if(!eftRefInput) return;
    eftRefInput.select();
    eftRefInput.setSelectionRange(0, 99999);
    document.execCommand("copy");
    alert("Reference copied: " + eftRefInput.value);
}

async function eftConfirm() {
    const message = buildMessage("EFT");
    const emailSent = await sendEmailNotification(message);
    if(emailSent) completeOrder();
    alert("Thank you! Please use this reference when making the EFT payment:\n\n" + ORDER_REF);
}

// Init
document.addEventListener("DOMContentLoaded", loadCheckout);
</script>

</body>
</html>
